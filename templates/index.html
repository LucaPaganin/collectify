{% extends "base.html" %}
{% block title %}My Collection{% endblock %}
{% block content %}
<div id="app">
    <div class="container py-4">
        <!-- Show error/success messages if present -->
        {% if error_message %}
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
            {{ error_message }}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
        {% endif %}
        
        {% if request.args.get('success') %}
        <div class="alert alert-success alert-dismissible fade show" role="alert">
            {{ request.args.get('success') }}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
        {% endif %}

        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1 class="mb-0">Collectible Items</h1>
            <a href="/admin.html" class="btn btn-outline-secondary">Manage Categories</a>
        </div>
        <div class="row mb-3">
            <div class="col-md-3">
                <select class="form-select" id="categorySelect">
                    <option value="">All Categories</option>
                    {% for category in categories %}
                    <option value="{{ category.id }}" {% if request.args.get('category_id')|string == category.id|string %}selected{% endif %}>{{ category.name }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-3">
                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#itemModal">Add New Item</button>
            </div>
            <div class="col-md-6 d-flex justify-content-end">
                <div class="btn-group me-2" role="group" aria-label="Selection Toggle">
                    <button type="button" class="btn btn-outline-danger" id="toggleSelectBtn">
                        <i class="bi bi-check-square"></i> Select
                    </button>
                    <button type="button" class="btn btn-danger d-none" id="deleteSelectedBtn">
                        <i class="bi bi-trash"></i> Delete Selected
                    </button>
                </div>
                <div class="btn-group" role="group" aria-label="View Toggle">
                    <button type="button" class="btn btn-outline-secondary active" id="galleryViewBtn">
                        <i class="bi bi-grid-3x3-gap-fill"></i> Gallery
                    </button>
                    <button type="button" class="btn btn-outline-secondary" id="listViewBtn">
                        <i class="bi bi-list-ul"></i> List
                    </button>
                </div>
            </div>
        </div>
    <!-- Gallery View -->
    <div id="itemGrid" class="row g-3 view-container">
      {% for item in items %}
      <div class="col-md-4">
        <div class="card h-100 position-relative">
          <div class="item-select-checkbox position-absolute top-0 end-0 m-2 d-none">
            <input type="checkbox" class="form-check-input item-checkbox" data-item-id="{{ item.id }}" style="width: 20px; height: 20px;">
          </div>
          <img src="{{ item.primary_photo_url }}" class="card-img-top" alt="Item image" style="width:300px;height:180px;object-fit:cover;">
          <div class="card-body">
            <h5 class="card-title">{{ item.name }}</h5>
            <p class="card-text">{{ item.brand or 'N/A' }}</p>
            <span class="badge bg-secondary">{{ item.category_name }}</span>
            <div class="mt-3 d-flex justify-content-between">
              <button type="button" 
                  class="btn btn-outline-danger btn-sm delete-item-btn"
                  data-item-id="{{ item.id }}">
                <i class="bi bi-trash"></i>
              </button>
              <button type="button"
                  class="btn btn-outline-primary btn-sm" 
                  data-bs-toggle="modal" data-bs-target="#itemModal"
                  data-item='{{ item|tojson | safe }}'>
                Edit/View
              </button>
            </div>
          </div>
        </div>
      </div>
      {% endfor %}
    </div>
    <!-- List View -->
    <div id="itemList" class="view-container" style="display:none;">
      <table class="table table-striped table-hover">
        <thead>
          <tr>
            <th class="item-select-checkbox d-none text-center" style="width: 50px;">
              <input type="checkbox" class="form-check-input" id="selectAllCheckbox" style="width: 20px; height: 20px;">
            </th>
            <th>Image</th>
            <th>Name</th>
            <th>Brand</th>
            <th>Category</th>
            <th>Serial Number</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          {% for item in items %}
          <tr>
            <td class="item-select-checkbox d-none text-center">
              <input type="checkbox" class="form-check-input item-checkbox" data-item-id="{{ item.id }}" style="width: 20px; height: 20px;">
            </td>
            <td><img src="{{ item.primary_photo_url }}" alt="Item image" style="width:80px;height:60px;object-fit:cover;"></td>
            <td>{{ item.name }}</td>
            <td>{{ item.brand or 'N/A' }}</td>
            <td><span class="badge bg-secondary">{{ item.category_name }}</span></td>
            <td>{{ item.serial_number or 'N/A' }}</td>
            <td>
              <div class="btn-group" role="group">
                <button type="button" 
                    class="btn btn-outline-danger btn-sm delete-item-btn"
                    data-item-id="{{ item.id }}">
                  <i class="bi bi-trash"></i>
                </button>
                <button type="button"
                  class="btn btn-outline-primary btn-sm" 
                  data-bs-toggle="modal" data-bs-target="#itemModal"
                  data-item='{{ item|tojson | safe }}'>
                  Edit/View
                </button>
              </div>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    </div>

    <!-- Add/Edit Item Modal -->
    <div class="modal fade" id="itemModal" tabindex="-1" aria-labelledby="itemModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="itemModalLabel">Add New Item</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <form id="itemForm" method="post" enctype="multipart/form-data" action="/api/items">
            <input type="hidden" name="item_id" id="itemId">
            <div class="modal-body">
              <div class="row g-3">
                <div class="col-md-6">
                  <label for="name" class="form-label">Name*</label>
                  <input type="text" class="form-control" id="name" name="name" required>
                </div>
                <div class="col-md-6">
                  <label for="category" class="form-label">Category*</label>
                  <select class="form-select" id="category" name="category_id" required>
                    <option value="">Select a category</option>
                    {% for cat in categories %}
                    <option value="{{ cat.id }}">{{ cat.name }}</option>
                    {% endfor %}
                  </select>
                </div>
                <div class="col-md-6">
                  <label for="brand" class="form-label">Brand*</label>
                  <input type="text" class="form-control" id="brand" name="brand" required>
                </div>
                <div class="col-md-6">
                  <label for="serial" class="form-label">Serial Number</label>
                  <input type="text" class="form-control" id="serial" name="serial_number">
                </div>
                <div class="col-12">
                  <label for="form_factor" class="form-label">Form Factor</label>
                  <input type="text" class="form-control" id="form_factor" name="form_factor">
                </div>
                <div class="col-12">
                  <label for="desc" class="form-label">Description</label>
                  <textarea class="form-control" id="desc" name="description" rows="3"></textarea>
                </div>
                <div class="col-12">
                  <label class="form-label">Photos</label>
                  <div class="input-group">
                    <input type="file" class="form-control" id="photos" name="photos[]" multiple accept="image/*">
                    <button type="button" class="btn btn-primary" id="takePictureBtn">
                      <i class="bi bi-camera"></i> Take Photo
                    </button>
                  </div>
                  <div id="capturedImagesPreview" class="d-flex flex-wrap gap-2 mt-2">
                    <!-- Captured images will be shown here -->
                  </div>
                </div>
              </div>
              <div class="mt-3">
                <label class="form-label">Additional Specifications</label>
                <div id="specificationsList"></div>
              </div>
              <div class="mt-3">
                <label class="form-label">Related URLs</label>
                <div id="urlsList"></div>
                <button type="button" class="btn btn-sm btn-outline-primary mt-2" id="addUrlBtn" onclick="addNewUrl()">Add URL</button>
              </div>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-danger me-auto d-none" id="modalDeleteBtn">
                <i class="bi bi-trash"></i> Delete Item
              </button>
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
              <button type="submit" class="btn btn-primary" id="modalSubmitBtn">Create Item</button>
            </div>
          </form>
        </div>
      </div>
    </div>
</div>
<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteConfirmModal" tabindex="-1" aria-labelledby="deleteConfirmModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header bg-danger text-white">
        <h5 class="modal-title" id="deleteConfirmModalLabel">Confirm Delete</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body" id="deleteConfirmBody">
        Are you sure you want to delete this item? This action cannot be undone.
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-danger" id="confirmDeleteBtn">Delete</button>
      </div>
    </div>
  </div>
</div>

<!-- Batch Delete Confirmation Modal -->
<div class="modal fade" id="batchDeleteConfirmModal" tabindex="-1" aria-labelledby="batchDeleteConfirmModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header bg-danger text-white">
        <h5 class="modal-title" id="batchDeleteConfirmModalLabel">Confirm Multiple Delete</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        Are you sure you want to delete <span id="deleteItemCount">0</span> item(s)? This action cannot be undone.
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-danger" id="confirmBatchDeleteBtn">Delete All Selected</button>
      </div>
    </div>
  </div>
</div>

<!-- Camera Modal -->
<div class="modal fade" id="cameraModal" tabindex="-1" aria-labelledby="cameraModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="cameraModalLabel">Take a Photo</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="camera-container">
          <video id="cameraFeed" class="w-100" autoplay playsinline></video>
          <canvas id="photoCanvas" class="d-none"></canvas>
        </div>
        <div class="text-center mt-3" id="cameraErrorMessage" style="display: none;">
          <div class="alert alert-warning">
            Camera access denied or not available. Please check your camera permissions.
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        <button type="button" class="btn btn-primary" id="capturePhotoBtn">
          <i class="bi bi-camera"></i> Capture Photo
        </button>
      </div>
    </div>
  </div>
</div>

<script src="/static/app-bootstrap.js"></script>
<script src="/static/item-modal-handler.js"></script>
<script src="/static/item-delete-handler.js"></script>
<script src="/static/form-submit-handler.js"></script>
<script src="/static/camera-handler.js"></script>
{% endblock %}
