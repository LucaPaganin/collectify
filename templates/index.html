{% extends "base.html" %}
{% block title %}My Collection{% endblock %}
{% block content %}
<div id="app">
    <div class="container py-4">
        <!-- Show error/success messages if present -->
        {% if error_message %}
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
            {{ error_message }}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
        {% endif %}
        
        {% if request.args.get('success') %}
        <div class="alert alert-success alert-dismissible fade show" role="alert">
            {{ request.args.get('success') }}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
        {% endif %}

        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1 class="mb-0">Collectible Items</h1>
            <a href="/admin.html" class="btn btn-outline-secondary">Manage Categories</a>
        </div>
        <div class="row mb-3">
            <div class="col-md-4">
                <select class="form-select" id="categorySelect">
                    <option value="">All Categories</option>
                </select>
            </div>
            <div class="col-md-4">
                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#itemModal">Add New Item</button>
            </div>
        </div>
    <div id="itemGrid" class="row g-3">
      {% for item in items %}
      <div class="col-md-4">
        <div class="card h-100">
          <img src="{{ item.primary_photo_url }}" class="card-img-top" alt="Item image" style="width:300px;height:180px;object-fit:cover;">
          <div class="card-body">
            <h5 class="card-title">{{ item.name }}</h5>
            <p class="card-text">{{ item.brand or 'N/A' }}</p>
            <span class="badge bg-secondary">{{ item.category_name }}</span>
            <div class="mt-3 d-flex justify-content-end">
              <button type="button"
                  class="btn btn-outline-primary btn-sm" 
                  data-bs-toggle="modal" data-bs-target="#itemModal"
                  data-item='{{ item|tojson | safe }}'>
                Edit/View
              </button>
            </div>
          </div>
        </div>
      </div>
      {% endfor %}
    </div>
    </div>

    <!-- Add/Edit Item Modal -->
    <div class="modal fade" id="itemModal" tabindex="-1" aria-labelledby="itemModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="itemModalLabel">Add New Item</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <form id="itemForm" method="post" enctype="multipart/form-data" action="/api/items">
            <input type="hidden" name="item_id" id="itemId">
            <div class="modal-body">
              <div class="row g-3">
                <div class="col-md-6">
                  <label for="name" class="form-label">Name*</label>
                  <input type="text" class="form-control" id="name" name="name" required>
                </div>
                <div class="col-md-6">
                  <label for="category" class="form-label">Category*</label>
                  <select class="form-select" id="category" name="category_id" required>
                    <option value="">Select a category</option>
                    {% for cat in categories %}
                    <option value="{{ cat.id }}">{{ cat.name }}</option>
                    {% endfor %}
                  </select>
                </div>
                <div class="col-md-6">
                  <label for="brand" class="form-label">Brand*</label>
                  <input type="text" class="form-control" id="brand" name="brand" required>
                </div>
                <div class="col-md-6">
                  <label for="serial" class="form-label">Serial Number</label>
                  <input type="text" class="form-control" id="serial" name="serial_number">
                </div>
                <div class="col-12">
                  <label for="form_factor" class="form-label">Form Factor</label>
                  <input type="text" class="form-control" id="form_factor" name="form_factor">
                </div>
                <div class="col-12">
                  <label for="desc" class="form-label">Description</label>
                  <textarea class="form-control" id="desc" name="description" rows="3"></textarea>
                </div>
                <div class="col-12">
                  <label class="form-label">Photos</label>
                  <input type="file" class="form-control" id="photos" name="photos[]" multiple accept="image/*">
                </div>
              </div>
              <div class="mt-3">
                <label class="form-label">Additional Specifications</label>
                <div id="specificationsList"></div>
                <button type="button" class="btn btn-sm btn-outline-primary mt-2" id="addSpecBtn">Add Specification</button>
              </div>
              <div class="mt-3">
                <label class="form-label">Related URLs</label>
                <div id="urlsList"></div>
                <button type="button" class="btn btn-sm btn-outline-primary mt-2" id="addUrlBtn" onclick="addNewUrl()">Add URL</button>
              </div>
              <script>
                function addNewUrl() {
                  const urlsList = document.getElementById('urlsList');
                  const div = document.createElement('div');
                  div.className = 'input-group mb-2';
                  div.innerHTML = `
                    <input type="url" class="form-control" name="urls[]" placeholder="https://example.com">
                    <button type="button" class="btn btn-outline-danger" onclick="this.closest('.input-group').remove()">&times;</button>
                  `;
                  urlsList.appendChild(div);
                }
              </script>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
              <button type="submit" class="btn btn-primary" id="modalSubmitBtn">Create Item</button>
            </div>
          </form>
        </div>
      </div>
    </div>
</div>
<script src="/static/app-bootstrap.js"></script>
<script>
// Handle load data into modal for edit
var itemModalEl = document.getElementById('itemModal');
itemModalEl.addEventListener('show.bs.modal', function (event) {
  var button = event.relatedTarget;
  var itemData = button.getAttribute('data-item');
  var modalTitle = document.getElementById('itemModalLabel');
  var form = document.getElementById('itemForm');
  var submitBtn = document.getElementById('modalSubmitBtn');
  var itemObj = itemData ? JSON.parse(itemData) : null;
  
  if (itemObj) {
    // Edit mode
    modalTitle.textContent = 'Edit Item';
    form.action = '/item/' + itemObj.id + '/edit';
    submitBtn.textContent = 'Save Changes';
    
    // Fill fields
    document.getElementById('itemId').value = itemObj.id;
    document.getElementById('name').value = itemObj.name || '';
    document.getElementById('brand').value = itemObj.brand || '';
    document.getElementById('serial').value = itemObj.serial_number || '';
    document.getElementById('form_factor').value = itemObj.form_factor || '';
    document.getElementById('desc').value = itemObj.description || '';
    
    // Set the category and fetch its specification schema
    var categoryField = document.getElementById('category');
    categoryField.value = itemObj.category_id || '';
    
    // Clear file input - we don't show existing photos here since they're already stored
    document.getElementById('photos').value = null;
    
    // Fetch the category schema first, then set the specification values
    if (itemObj.category_id) {
      fetch(`/api/categories/${itemObj.category_id}/specifications_schema`)
        .then(res => res.json())
        .then(schema => {
          // Store the schema globally so the specification fields can be rendered properly
          window.currentCategorySchema = schema;
          
          // Set the specification values
          if (itemObj.specification_values) {
            window.specValues = itemObj.specification_values;
          } else {
            window.specValues = {};
          }
          
          // Render the specification fields with the values
          if (typeof renderSpecificationFields === 'function') {
            renderSpecificationFields();
          }
          
          // Create a hidden input field for the specification values
          let existingSpecInput = form.querySelector('input[name="specification_values"]');
          if (existingSpecInput) {
            existingSpecInput.value = JSON.stringify(window.specValues);
          } else {
            let specInput = document.createElement('input');
            specInput.type = 'hidden';
            specInput.name = 'specification_values';
            specInput.value = JSON.stringify(window.specValues);
            form.appendChild(specInput);
          }
        });
    }
    
    // Handle URLs - show existing ones
    if (itemObj.urls && itemObj.urls.length > 0) {
      // If we have the global urls array and renderUrls function from app-bootstrap.js
      if (window.urls !== undefined && typeof renderUrls === 'function') {
        window.urls = itemObj.urls.map(url => ({ value: url }));
        renderUrls();
      } else {
        // Otherwise add them manually to the DOM
        const urlsList = document.getElementById('urlsList');
        urlsList.innerHTML = '';
        
        itemObj.urls.forEach(url => {
          const div = document.createElement('div');
          div.className = 'input-group mb-2';
          div.innerHTML = `
            <input type="url" class="form-control" name="urls[]" value="${url}" placeholder="https://example.com">
            <button type="button" class="btn btn-outline-danger url-remove-btn">&times;</button>
          `;
          urlsList.appendChild(div);
        });
        
        // Add event listeners to remove buttons
        document.querySelectorAll('.url-remove-btn').forEach(btn => {
          btn.addEventListener('click', function() {
            this.closest('.input-group').remove();
          });
        });
      }
    } else {
      // No URLs for this item
      if (window.urls !== undefined && typeof renderUrls === 'function') {
        window.urls = [];
        renderUrls();
      } else {
        document.getElementById('urlsList').innerHTML = '';
      }
    }
  } else {
    // Create mode
    modalTitle.textContent = 'Add New Item';
    form.action = '/api/items';
    submitBtn.textContent = 'Create Item';
    form.reset();
    
    // Reset specification values
    window.specValues = {};
    
    // If the category field has a value, fetch the schema for it
    var categoryField = document.getElementById('category');
    if (categoryField.value) {
      fetch(`/api/categories/${categoryField.value}/specifications_schema`)
        .then(res => res.json())
        .then(schema => {
          window.currentCategorySchema = schema;
          if (typeof renderSpecificationFields === 'function') {
            renderSpecificationFields();
          }
        });
    } else {
      window.currentCategorySchema = {};
      if (typeof renderSpecificationFields === 'function') {
        renderSpecificationFields();
      }
    }
    
    // Reset URLs
    if (window.urls !== undefined && typeof renderUrls === 'function') {
      window.urls = [];
      renderUrls();
    } else {
      document.getElementById('urlsList').innerHTML = '';
    }
    
    // Remove any hidden specification_values input if it exists
    let existingSpecInput = form.querySelector('input[name="specification_values"]');
    if (existingSpecInput) {
      existingSpecInput.remove();
    }
  }
});
</script>
{% endblock %}
