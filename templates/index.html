<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Collection</title>
    <link rel="stylesheet" href="/static/style.css">
    <script src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
</head>
<body x-data="app()">
    <header>
        <h1>Collectible Items</h1>
        <div class="controls">
            <select x-model="selectedCategory" @change="fetchItems()">
                <option value="">All Categories</option>
                <template x-for="category in categories" :key="category.id">
                    <option :value="category.id" x-text="category.name"></option>
                </template>
            </select>
            <button @click="showItemForm()">Add New Item</button>
            <a href="/admin.html" class="admin-link">Manage Categories</a>
        </div>
    </header>

    <main>
        <div class="item-grid">
            <template x-if="loading">
                <p>Loading items...</p>
            </template>
            <template x-if="!loading && items.length === 0">
                <p>No items found. Click "Add New Item" to get started!</p>
            </template>
            <!-- Item Card -->
            <template x-for="item in items" :key="item.id">
                <div class="item-card" @click="fetchItemDetails(item.id)">
                    <img :src="item.primary_photo ? '/uploads/' + item.primary_photo : 'https://placehold.co/600x400/eee/ccc?text=No+Image'" alt="Item image">
                    <div class="item-card-info">
                        <h3 x-text="item.name"></h3>
                        <p x-text="item.brand || 'N/A'"></p>
                        <span class="category-badge" x-text="item.category_name"></span>
                    </div>
                </div>
            </template>
        </div>
    </main>

    <!-- Details Modal -->
    <div class="modal-overlay" x-show="isModalOpen" @click.self="isModalOpen = false" x-cloak>
        <div class="modal-content" @click.stop>
            <button class="modal-close" @click="isModalOpen = false">&times;</button>
            <template x-if="modalLoading"><p>Loading details...</p></template>
            <template x-if="!modalLoading && currentItem">
                <div>
                    <div class="modal-header">
                        <h2 x-text="currentItem.name"></h2>
                        <div class="modal-actions">
                            <button @click="prepareEditForm(currentItem.id)">Edit</button>
                            <button @click="deleteItem(currentItem.id)" class="btn-delete">Delete</button>
                        </div>
                    </div>
                    <span class="category-badge" x-text="currentItem.category_name"></span>
                    <p><strong>Brand:</strong> <span x-text="currentItem.brand"></span></p>
                    <p><strong>Serial #:</strong> <span x-text="currentItem.serial_number"></span></p>
                    <p><strong>Form Factor:</strong> <span x-text="currentItem.form_factor"></span></p>
                    <p x-show="currentItem.description"><strong>Description:</strong> <span x-text="currentItem.description"></span></p>
                    
                    <div x-show="Object.keys(currentItem.specifications).length > 0">
                        <h4>Specifications</h4>
                        <ul class="spec-list">
                            <template x-for="[key, value] of Object.entries(currentItem.specifications)">
                                <li><strong x-text="key"></strong>: <span x-text="value"></span></li>
                            </template>
                        </ul>
                    </div>

                    <div x-show="currentItem.urls.length > 0">
                        <h4>Related Links</h4>
                        <ul>
                            <template x-for="url in currentItem.urls">
                                <li><a :href="url" target="_blank" rel="noopener noreferrer" x-text="url"></a></li>
                            </template>
                        </ul>
                    </div>

                    <h4>Photos</h4>
                    <div class="photo-gallery">
                        <template x-if="currentItem.photos.length === 0"><p>No photos available.</p></template>
                        <template x-for="photo in currentItem.photos">
                            <a :href="'/uploads/' + photo" target="_blank"><img :src="'/uploads/' + photo" alt="Item photo"></a>
                        </template>
                    </div>
                </div>
            </template>
        </div>
    </div>

    <!-- Item Form Modal -->
    <div class="modal-overlay" x-show="isFormOpen" x-cloak>
        <div class="modal-content large" @click.stop>
            <button class="modal-close" @click="closeItemForm()">&times;</button>
            <h2 x-text="form.id ? 'Edit Item' : 'Add New Item'"></h2>
            <form id="itemForm" @submit.prevent="saveItem">
                <div class="form-grid">
                    <div class="form-group"><label for="name">Name*</label><input type="text" id="name" x-model="form.name" required></div>
                    <div class="form-group"><label for="category">Category</label><select id="category" x-model="form.category_id"><template x-for="cat in categories" :key="cat.id"><option :value="cat.id" x-text="cat.name"></option></template></select></div>
                    <div class="form-group"><label for="brand">Brand</label><input type="text" id="brand" x-model="form.brand"></div>
                    <div class="form-group"><label for="serial">Serial Number</label><input type="text" id="serial" x-model="form.serial_number"></div>
                    <div class="form-group full-width"><label for="form_factor">Form Factor</label><input type="text" id="form_factor" x-model="form.form_factor"></div>
                    <div class="form-group full-width"><label for="desc">Description</label><textarea id="desc" x-model="form.description" rows="3"></textarea></div>
                </div>

                <div class="form-section"><h3>Additional Specifications</h3><template x-for="(spec, index) in form.specifications" :key="index"><div class="spec-row"><input type="text" x-model="spec.key" placeholder="Attribute (e.g., 'Weight')"><input type="text" x-model="spec.value" placeholder="Value (e.g., '250g')"><button type="button" @click="removeSpec(index)" class="btn-delete">&times;</button></div></template><button type="button" @click="addSpec">Add Specification</button></div>
                <div class="form-section"><h3>Related URLs</h3><template x-for="(url, index) in form.urls" :key="index"><div class="url-row"><input type="url" x-model="url.value" placeholder="https://example.com"><button type="button" @click="removeUrl(index)" class="btn-delete">&times;</button></div></template><button type="button" @click="addUrl">Add URL</button></div>
                <div class="form-section"><h3>Photos</h3><input type="file" id="photos" multiple accept="image/*"><div class="photo-gallery" x-show="form.id && form.existing_photos.length > 0"><p>Existing Photos:</p><template x-for="photo in form.existing_photos"><img :src="'/uploads/' + photo" class="thumb"></template></div></div>
                <div class="form-actions"><button type="button" @click="closeItemForm()">Cancel</button><button type="submit" x-text="form.id ? 'Save Changes' : 'Create Item'"></button></div>
            </form>
        </div>
    </div>

    <script>
        function app() {
            const defaultForm = { id: null, name: '', category_id: 1, brand: '', serial_number: '', form_factor: '', description: '', specifications: [], urls: [], existing_photos: [] };
            return {
                // State for main page
                loading: true,
                items: [],
                categories: [],
                selectedCategory: '',
                // State for details modal
                isModalOpen: false,
                modalLoading: false,
                currentItem: null,
                // State for form modal
                isFormOpen: false,
                form: { ...defaultForm },

                init() {
                    this.fetchCategories();
                    this.fetchItems();
                },
                fetchCategories() {
                    fetch('/api/categories').then(res => res.json()).then(data => {
                        this.categories = data;
                        if (data.length > 0) defaultForm.category_id = data[0].id;
                    });
                },
                fetchItems() {
                    this.loading = true;
                    fetch(`/api/items${this.selectedCategory ? `?category_id=${this.selectedCategory}` : ''}`)
                        .then(res => res.json()).then(data => { this.items = data; this.loading = false; });
                },
                fetchItemDetails(id) {
                    this.isModalOpen = true; this.modalLoading = true; this.currentItem = null;
                    fetch(`/api/items/${id}`).then(res => res.json()).then(data => { this.currentItem = data; this.modalLoading = false; });
                },
                // Form management
                showItemForm() {
                    this.form = { ...defaultForm, specifications: [], urls: [] };
                    this.form.category_id = this.categories.length > 0 ? this.categories[0].id : '';
                    this.isFormOpen = true;
                },
                closeItemForm() {
                    this.isFormOpen = false;
                    document.getElementById('itemForm').reset();
                },
                prepareEditForm(id) {
                    this.isModalOpen = false; // Close details modal
                    fetch(`/api/items/${id}`).then(res => res.json()).then(item => {
                        this.form = {
                            id: item.id,
                            name: item.name,
                            category_id: item.category_id,
                            brand: item.brand,
                            serial_number: item.serial_number,
                            form_factor: item.form_factor,
                            description: item.description,
                            specifications: Object.entries(item.specifications || {}).map(([k, v]) => ({ key: k, value: v })),
                            urls: (item.urls || []).map(u => ({ value: u })),
                            existing_photos: item.photos || []
                        };
                        this.isFormOpen = true; // Open form modal
                    });
                },
                saveItem() {
                    const formData = new FormData();
                    Object.keys(this.form).forEach(key => {
                        if (['name', 'category_id', 'brand', 'serial_number', 'form_factor', 'description'].includes(key)) {
                            formData.append(key, this.form[key]);
                        }
                    });
                    const specsObject = this.form.specifications.reduce((obj, spec) => { if (spec.key) obj[spec.key] = spec.value; return obj; }, {});
                    formData.append('specifications', JSON.stringify(specsObject));
                    this.form.urls.forEach(url => { if (url.value) formData.append('urls[]', url.value); });
                    for (const file of document.getElementById('photos').files) { formData.append('photos[]', file); }

                    fetch(this.form.id ? `/api/items/${this.form.id}` : '/api/items', { method: this.form.id ? 'PUT' : 'POST', body: formData })
                        .then(res => res.json()).then(() => { this.fetchItems(); this.closeItemForm(); })
                        .catch(err => alert('An error occurred: ' + err.message));
                },
                deleteItem(id) {
                    if (!confirm('Are you sure you want to delete this item? This is permanent.')) return;
                    fetch(`/api/items/${id}`, { method: 'DELETE' }).then(res => res.json()).then(() => {
                        this.fetchItems();
                        this.isModalOpen = false; // Close the details modal if open
                    }).catch(err => alert('An error occurred.'));
                },
                // Helpers for dynamic form fields
                addSpec() { this.form.specifications.push({ key: '', value: '' }); },
                removeSpec(index) { this.form.specifications.splice(index, 1); },
                addUrl() { this.form.urls.push({ value: '' }); },
                removeUrl(index) { this.form.urls.splice(index, 1); },
            }
        }
    </script>
</body>
</html>
