<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel</title>
    <link rel="stylesheet" href="/static/style.css">
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
</head>
<body x-data="adminApp()">
    <header>
        <h1>Admin Panel</h1>
        <div class="filters">
            <a href="/">Back to Public View</a>
        </div>
    </header>

    <main class="admin-layout">
        <section>
            <h2>Manage Categories</h2>
            <div class="category-list">
                <ul>
                    <template x-for="cat in categories" :key="cat.id">
                        <li>
                            <span x-text="cat.name"></span>
                            <button @click="deleteCategory(cat.id)" class="btn-delete">&times;</button>
                        </li>
                    </template>
                </ul>
            </div>
            <form @submit.prevent="addCategory" class="category-form">
                <input type="text" x-model="newCategoryName" placeholder="New category name" required>
                <button type="submit">Add Category</button>
            </form>
        </section>

        <section class="item-management">
            <h2>Manage Items</h2>
            <button @click="showItemForm()" class="btn-add-item">Add New Item</button>
            <div class="item-grid-admin">
                <template x-if="loading">
                    <p>Loading items...</p>
                </template>
                <template x-for="item in items" :key="item.id">
                    <div class="item-card-admin">
                        <img :src="item.primary_photo ? '/uploads/' + item.primary_photo : 'https://via.placeholder.com/300x200?text=No+Image'" alt="Item image">
                        <div class="item-card-info">
                            <h3 x-text="item.name"></h3>
                            <p x-text="item.brand"></p>
                        </div>
                        <div class="item-card-actions">
                            <button @click="editItem(item.id)">Edit</button>
                            <button @click="deleteItem(item.id)" class="btn-delete">Delete</button>
                        </div>
                    </div>
                </template>
            </div>
        </section>
    </main>
    
    <div class="modal-overlay" x-show="isFormOpen" x-cloak>
        <div class="modal-content large" @click.stop>
            <button class="modal-close" @click="closeItemForm()">&times;</button>
            <h2 x-text="form.id ? 'Edit Item' : 'Add New Item'"></h2>
            <form id="itemForm" @submit.prevent="saveItem">
                <div class="form-grid">
                    <div class="form-group">
                        <label for="name">Name*</label>
                        <input type="text" id="name" x-model="form.name" required>
                    </div>
                    <div class="form-group">
                        <label for="category">Category</label>
                        <select id="category" x-model="form.category_id">
                            <template x-for="cat in categories" :key="cat.id">
                                <option :value="cat.id" x-text="cat.name"></option>
                            </template>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="brand">Brand</label>
                        <input type="text" id="brand" x-model="form.brand">
                    </div>
                    <div class="form-group">
                        <label for="serial">Serial Number</label>
                        <input type="text" id="serial" x-model="form.serial_number">
                    </div>
                    <div class="form-group full-width">
                        <label for="form_factor">Form Factor</label>
                        <input type="text" id="form_factor" x-model="form.form_factor">
                    </div>
                    <div class="form-group full-width">
                        <label for="desc">Description</label>
                        <textarea id="desc" x-model="form.description" rows="3"></textarea>
                    </div>
                </div>

                <div class="form-section">
                    <h3>Additional Specifications</h3>
                    <template x-for="(spec, index) in form.specifications" :key="index">
                        <div class="spec-row">
                            <input type="text" x-model="spec.key" placeholder="Attribute (e.g., 'Weight')">
                            <input type="text" x-model="spec.value" placeholder="Value (e.g., '250g')">
                            <button type="button" @click="removeSpec(index)" class="btn-delete">&times;</button>
                        </div>
                    </template>
                    <button type="button" @click="addSpec">Add Specification</button>
                </div>
                
                <div class="form-section">
                    <h3>Related URLs</h3>
                    <template x-for="(url, index) in form.urls" :key="index">
                        <div class="url-row">
                             <input type="url" x-model="url.value" placeholder="https://example.com">
                             <button type="button" @click="removeUrl(index)" class="btn-delete">&times;</button>
                        </div>
                    </template>
                    <button type="button" @click="addUrl">Add URL</button>
                </div>

                <div class="form-section">
                    <h3>Photos</h3>
                    <input type="file" id="photos" multiple accept="image/*">
                    <div class="photo-gallery" x-show="form.id && form.existing_photos.length > 0">
                        <p>Existing Photos:</p>
                        <template x-for="photo in form.existing_photos">
                            <img :src="'/uploads/' + photo" class="thumb">
                        </template>
                    </div>
                </div>

                <div class="form-actions">
                    <button type="button" @click="closeItemForm()">Cancel</button>
                    <button type="submit" x-text="form.id ? 'Save Changes' : 'Create Item'"></button>
                </div>
            </form>
        </div>
    </div>

    <script>
        function adminApp() {
            const defaultForm = {
                id: null,
                name: '',
                category_id: 1, // Default to 'Uncategorized'
                brand: '',
                serial_number: '',
                form_factor: '',
                description: '',
                specifications: [], // For the UI: [{key, value}]
                urls: [], // For the UI: [{value}]
                existing_photos: []
            };

            return {
                loading: true,
                items: [],
                categories: [],
                newCategoryName: '',
                isFormOpen: false,
                form: { ...defaultForm },

                init() {
                    this.fetchCategories();
                    this.fetchItems();
                },
                fetchCategories() {
                    fetch('/api/categories')
                        .then(res => res.json())
                        .then(data => {
                            this.categories = data;
                            // Set default category if not already set
                            if (!this.form.category_id && data.length > 0) {
                                this.form.category_id = data[0].id;
                            }
                        });
                },
                addCategory() {
                    fetch('/api/categories', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ name: this.newCategoryName })
                    })
                    .then(res => {
                        if (!res.ok) throw new Error('Category already exists');
                        return res.json();
                    })
                    .then(newCategory => {
                        this.categories.push(newCategory);
                        this.categories.sort((a, b) => a.name.localeCompare(b.name));
                        this.newCategoryName = '';
                    })
                    .catch(err => alert(err.message));
                },
                deleteCategory(id) {
                    if (!confirm('Are you sure? This cannot be undone.')) return;
                    fetch(`/api/categories/${id}`, { method: 'DELETE' })
                    .then(res => {
                        if (!res.ok) {
                            return res.json().then(err => { throw new Error(err.error) });
                        }
                        return res.json();
                    })
                    .then(() => {
                        this.categories = this.categories.filter(c => c.id !== id);
                        this.fetchItems(); // Refresh items in case any were in that category
                    })
                    .catch(err => alert(err.message));
                },
                fetchItems() {
                    this.loading = true;
                    fetch('/api/items')
                        .then(res => res.json())
                        .then(data => {
                            this.items = data;
                            this.loading = false;
                        });
                },
                showItemForm() {
                    this.form = { ...defaultForm, specifications: [], urls: [] };
                    this.form.category_id = this.categories.length > 0 ? this.categories[0].id : '';
                    this.isFormOpen = true;
                },
                closeItemForm() {
                    this.isFormOpen = false;
                    document.getElementById('itemForm').reset();
                },
                addSpec() { this.form.specifications.push({ key: '', value: '' }); },
                removeSpec(index) { this.form.specifications.splice(index, 1); },
                addUrl() { this.form.urls.push({ value: '' }); },
                removeUrl(index) { this.form.urls.splice(index, 1); },

                editItem(id) {
                    fetch(`/api/items/${id}`)
                    .then(res => res.json())
                    .then(item => {
                        this.form.id = item.id;
                        this.form.name = item.name;
                        this.form.category_id = item.category_id;
                        this.form.brand = item.brand;
                        this.form.serial_number = item.serial_number;
                        this.form.form_factor = item.form_factor;
                        this.form.description = item.description;
                        this.form.specifications = Object.entries(item.specifications || {}).map(([k, v]) => ({ key: k, value: v }));
                        this.form.urls = (item.urls || []).map(u => ({ value: u }));
                        this.form.existing_photos = item.photos || [];
                        this.isFormOpen = true;
                    });
                },
                saveItem() {
                    const formData = new FormData();
                    formData.append('name', this.form.name);
                    formData.append('category_id', this.form.category_id);
                    formData.append('brand', this.form.brand);
                    formData.append('serial_number', this.form.serial_number);
                    formData.append('form_factor', this.form.form_factor);
                    formData.append('description', this.form.description);

                    // Convert specs array to a JSON string
                    const specsObject = this.form.specifications.reduce((obj, spec) => {
                        if (spec.key) obj[spec.key] = spec.value;
                        return obj;
                    }, {});
                    formData.append('specifications', JSON.stringify(specsObject));

                    // Append URLs
                    this.form.urls.forEach(url => {
                        if (url.value) formData.append('urls[]', url.value);
                    });

                    // Append new photos
                    const photoInput = document.getElementById('photos');
                    for (const file of photoInput.files) {
                        formData.append('photos[]', file);
                    }

                    const url = this.form.id ? `/api/items/${this.form.id}` : '/api/items';
                    const method = this.form.id ? 'PUT' : 'POST';

                    fetch(url, { method: method, body: formData }) // No Content-Type header with FormData
                    .then(res => res.json())
                    .then(data => {
                        this.fetchItems();
                        this.closeItemForm();
                    })
                    .catch(err => alert('An error occurred: ' + err.message));
                },
                deleteItem(id) {
                     if (!confirm('Are you sure you want to delete this item? This is permanent.')) return;
                     fetch(`/api/items/${id}`, { method: 'DELETE' })
                     .then(res => res.json())
                     .then(() => this.fetchItems())
                     .catch(err => alert('An error occurred.'));
                }
            }
        }
    </script>
</body>
</html>